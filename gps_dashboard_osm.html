<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GPS Tacho Dashboard (OSM)</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  crossorigin=""/>

<style>
:root{
  --glass-bg: rgba(255,255,255,0.22);
  --glass-strong: rgba(255,255,255,0.35);
}
html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
body{display:flex;flex-direction:column;background:#f0f0f5;}
#header{padding:10px;background:#007bff;color:white;text-align:center;font-weight:600;backdrop-filter:blur(8px);}
#content{display:flex;flex:1;gap:10px;padding:10px;box-sizing:border-box;}
#map{flex:2;border-radius:14px;overflow:hidden;min-height:300px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
#sidebar{flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;border-radius:16px;background:var(--glass-bg);backdrop-filter:blur(14px);box-shadow:0 10px 30px rgba(0,0,0,0.12)}
.controls{display:flex;gap:8px;margin-bottom:8px;}
button{padding:10px;border-radius:12px;border:0;background:var(--glass-strong);cursor:pointer;font-weight:600}
#routesList{width:100%;max-height:140px;overflow:auto;border-radius:10px;background:rgba(255,255,255,0.12);padding:6px;margin-bottom:8px}
.routeItem{padding:6px;border-bottom:1px solid rgba(255,255,255,0.08);cursor:pointer}
.routeItem:hover{background:rgba(255,255,255,0.08)}
#timeline{width:100%;margin-top:8px}
#tachoCanvas{width:200px;height:200px;border-radius:50%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), rgba(0,0,0,0.18));box-shadow:inset -6px -6px 22px rgba(255,255,255,0.12), inset 6px 6px 22px rgba(0,0,0,0.15);margin:8px 0}
.infoBox{width:100%;padding:6px;text-align:left;color:#000}
.infoBox p{margin:6px 0}
@media(max-width:900px){
  #content{flex-direction:column}
  #map{order:1}
  #sidebar{order:2}
}
</style>
</head>
<body>
<div id="header">GPS Tacho Dashboard (OpenStreetMap)</div>
<div id="content">
  <div id="map"></div>
  <div id="sidebar">
    <div class="controls">
      <button id="menuBtn">Routen</button>
      <button id="saveBtn">Route speichern</button>
    </div>
    <div id="routesList" style="display:none"></div>
    <canvas id="tachoCanvas" width="200" height="200"></canvas>
    <div class="infoBox">
      <p id="speedInfo">Speed: 0 km/h</p>
      <p id="avgSpeed">Durchschnitt: 0 km/h</p>
      <p id="timeInfo">Zeit: 0 s</p>
      <p id="altitudeInfo">Höhe: —</p>
    </div>
    <input id="timeline" type="range" min="0" max="0" value="0"/>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="replayBtn">Abspielen</button>
      <button id="stopReplayBtn">Stop</button>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
// -- State --
let map, liveMarker=null, segments=[], currentRoute=[], allRoutes=JSON.parse(localStorage.getItem('allRoutes')||'[]');
let startTime=null, watchId=null, replayTimer=null, replayIndex=0, replayRoute=null, playbackMarker=null;

// --- Map init ---
function initMap(){
  map=L.map('map',{zoomControl:true}).setView([51.1657,10.4515],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
}
initMap();

// --- Color helper ---
function colorForSpeed(s){return s<=30?'#2ecc71':s<=60?'#f1c40f':'#e74c3c';}

// --- Tacho ---
function drawTacho(speed){
  const c=document.getElementById('tachoCanvas'),ctx=c.getContext('2d'),w=c.width,h=c.height;
  ctx.clearRect(0,0,w,h);
  ctx.beginPath();ctx.arc(w/2,h/2,w/2-6,0,2*Math.PI);
  const grad=ctx.createRadialGradient(w/2.6,h/2.6,10,w/2,h/2,w/2);
  grad.addColorStop(0,'rgba(255,255,255,0.35)');grad.addColorStop(1,'rgba(30,30,30,0.45)');
  ctx.fillStyle=grad;ctx.fill();
  ctx.lineWidth=2;ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.stroke();
  const maxSpeed=180,a=(speed/maxSpeed)*Math.PI*1.5+Math.PI*0.75;
  ctx.beginPath();ctx.moveTo(w/2,h/2);ctx.lineTo(w/2+(w/2-26)*Math.cos(a),h/2+(h/2-26)*Math.sin(a));
  ctx.strokeStyle='rgba(255,40,40,0.95)';ctx.lineWidth=3;ctx.shadowColor='rgba(255,40,40,0.6)';ctx.shadowBlur=10;ctx.stroke();
  ctx.shadowBlur=0;ctx.beginPath();ctx.arc(w/2,h/2,5,0,2*Math.PI);ctx.fillStyle='rgba(255,255,255,0.9)';ctx.fill();
  ctx.fillStyle='white';ctx.font='16px system-ui';ctx.textAlign='center';ctx.fillText(Math.round(speed)+' km/h',w/2,h/2+56);
}

// --- Draw Route ---
function clearSegments(){segments.forEach(s=>map.removeLayer(s));segments=[];}
function drawColoredRoute(route){clearSegments();for(let i=1;i<route.length;i++){const p1=[route[i-1].lat,route[i-1].lng],p2=[route[i].lat,route[i].lng];segments.push(L.polyline([p1,p2],{color:colorForSpeed(route[i].speed),weight:4,opacity:1.0}).addTo(map));}}

// --- GPS ---
function onPosition(pos){
  const lat=pos.coords.latitude,lng=pos.coords.longitude,speed=(pos.coords.speed!==null&&!isNaN(pos.coords.speed)?+(pos.coords.speed*3.6).toFixed(1):0),altitude=(pos.coords.altitude!==null&&!isNaN(pos.coords.altitude)?+pos.coords.altitude.toFixed(1):null),t=Date.now();
  document.getElementById('speedInfo').innerText=`Speed: ${speed} km/h`;
  document.getElementById('altitudeInfo').innerText=`Höhe: ${altitude!==null?altitude+' m':'—'}`;
  drawTacho(speed);
  if(!liveMarker) liveMarker=L.circleMarker([lat,lng],{radius:6,color:'#007bff',fill:true,fillColor:'#007bff'}).addTo(map); else liveMarker.setLatLng([lat,lng]);
  if(!startTime) startTime=t;
  if(currentRoute.push){currentRoute.push({lat,lng,speed,altitude,timestamp:t});drawColoredRoute(currentRoute);map.panTo([lat,lng]);const sum=currentRoute.reduce((a,b)=>a+(b.speed||0),0),avg=currentRoute.length?(sum/currentRoute.length).toFixed(1):0;document.getElementById('avgSpeed').innerText=`Durchschnitt: ${avg} km/h`;document.getElementById('timeInfo').innerText=`Zeit: ${((t-startTime)/1000).toFixed(1)} s`;document.getElementById('timeline').max=Math.max(0,currentRoute.length-1);document.getElementById('timeline').value=currentRoute.length-1;}}
function onPosError(err){alert('GPS Fehler: '+err.message);}
function startWatching(){if('geolocation' in navigator){watchId=navigator.geolocation.watchPosition(onPosition,onPosError,{enableHighAccuracy:true,maximumAge:0,timeout:10000});}else alert('Geolocation nicht verfügbar');}
function stopWatching(){if(watchId!==null) navigator.geolocation.clearWatch(watchId);watchId=null;}

// --- Menu / Save / Load ---
const routesListDiv=document.getElementById('routesList');
document.getElementById('menuBtn').addEventListener('click',()=>{routesListDiv.style.display=(routesListDiv.style.display==='none'||routesListDiv.style.display==='')?'block':'none';renderRoutesList();});
document.getElementById('saveBtn').addEventListener('click',()=>{if(currentRoute.length===0){alert('Keine Route zum Speichern.');return;}allRoutes.push(currentRoute.slice());localStorage.setItem('allRoutes',JSON.stringify(allRoutes));alert('Route gespeichert.');currentRoute=[];startTime=null;if(liveMarker){map.removeLayer(liveMarker);liveMarker=null;}clearSegments();renderRoutesList();});
function renderRoutesList(){routesListDiv.innerHTML='';if(allRoutes.length===0){routesListDiv.innerHTML='<div style="padding:8px;color:rgba(0,0,0,0.6)">Keine Routen</div>';return;}allRoutes.forEach((r,idx)=>{const d=document.createElement('div');d.className='routeItem';const t0=new Date(r[0].timestamp);d.textContent=`Route ${idx+1} — ${r.length} Punkte — ${t0.toLocaleString()}`;d.addEventListener('click',()=>{loadRoute(idx);});routesListDiv.appendChild(d);});}
function loadRoute(index){replayRoute=allRoutes[index];drawColoredRoute(replayRoute);map.fitBounds(L.latLngBounds(replayRoute.map(p=>[p.lat,p.lng])));if(playbackMarker){map.removeLayer(playbackMarker);playbackMarker=null;}if(replayRoute.length>0){playbackMarker=L.circleMarker([replayRoute[0].lat,replayRoute[0].lng],{radius:7,color:'#000',fill:true,fillColor:'#fff'}).addTo(map);document.getElementById('timeline').max=replayRoute.length-1;document.getElementById('timeline').value=0;const p=replayRoute[0];document.getElementById('speedInfo').innerText=`Speed: ${p.speed} km/h`;document.getElementById('altitudeInfo').innerText=`Höhe: ${p.altitude!==null?p.altitude+' m':'—'}`;drawTacho(p.speed||0);}}
document.getElementById('replayBtn').addEventListener('click',()=>{if(!replayRoute||!replayRoute.length){alert('Bitte zuerst eine Route im Menu auswählen.');return;}clearInterval(replayTimer);replayIndex=0;stopWatching();replayTimer=setInterval(()=>{if(replayIndex>=replayRoute.length){clearInterval(replayTimer);replayTimer=null;return;}const p=replayRoute[replayIndex];if(playbackMarker)playbackMarker.setLatLng([p.lat,p.lng]);map.panTo([p.lat,p.lng]);document.getElementById('timeline').value=replayIndex;document.getElementById('speedInfo').innerText=`Speed: ${p.speed} km/h`;document.getElementById('altitudeInfo').innerText=`Höhe: ${p.altitude!==null?p.altitude+' m':'—'}`;drawTacho(p.speed||0);const sum=replayRoute.slice(0,replayIndex+1).reduce((a,b)=>a+(b.speed||0),0);document.getElementById('avgSpeed').innerText=`Durchschnitt: ${(sum/(replayIndex+1)).toFixed(1)} km/h`;document.getElementById('timeInfo').innerText=`Zeit: ${((p.timestamp-replayRoute[0].timestamp)/1000).toFixed(1)} s`;replayIndex++;},400);});
document.getElementById('stopReplayBtn').addEventListener('click',()=>{if(replayTimer){clearInterval(replayTimer);replayTimer=null;}if(!watchId) startWatching();});
document.getElementById('timeline').addEventListener('input',(e)=>{const idx=+e.target.value;if(!replayRoute||!replayRoute.length)return;const p=replayRoute[idx];if(playbackMarker)playbackMarker.setLatLng([p.lat,p.lng]);map.panTo([p.lat,p.lng]);document.getElementById('speedInfo').innerText=`Speed: ${p.speed} km/h`;document.getElementById('altitudeInfo').innerText=`Höhe: ${p.altitude!==null?p.altitude+' m':'—'}`;drawTacho(p.speed||0);const sum=replayRoute.slice(0,idx+1).reduce((a,b)=>a+(b.speed||0),0);document.getElementById('avgSpeed').innerText=`Durchschnitt: ${(sum/(idx+1)).toFixed(1)} km/h`;document.getElementById('timeInfo').innerText=`Zeit: ${((p.timestamp-replayRoute[0].timestamp)/1000).toFixed(1)} s`;});
startWatching();
if(allRoutes.length>0) renderRoutesList();
</script>
</body>
</html>
